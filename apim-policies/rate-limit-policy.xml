<!--
    Rate Limiting Policy for HoldThatThread API

    This policy implements tiered rate limiting based on subscription keys:
    - Free tier: 10 requests per minute
    - Standard tier: 100 requests per minute
    - Premium tier: 1000 requests per minute

    Apply this at the API level or specific operations that are expensive.
-->
<policies>
    <inbound>
        <base />

        <!-- Rate limit based on subscription key -->
        <rate-limit-by-key calls="100"
                           renewal-period="60"
                           counter-key="@(context.Subscription.Id)" />

        <!-- Alternative: Rate limit by IP for unauthenticated requests -->
        <!--
        <rate-limit-by-key calls="10"
                           renewal-period="60"
                           counter-key="@(context.Request.IpAddress)" />
        -->

        <!-- Quota limit: Total requests per day -->
        <quota-by-key calls="10000"
                      renewal-period="86400"
                      counter-key="@(context.Subscription.Id)" />
    </inbound>

    <backend>
        <base />
    </backend>

    <outbound>
        <base />

        <!-- Add rate limit headers to response -->
        <set-header name="X-Rate-Limit-Limit" exists-action="override">
            <value>100</value>
        </set-header>
        <set-header name="X-Rate-Limit-Remaining" exists-action="override">
            <value>@{
                var remainingCalls = 100;
                // Note: Actual remaining calls would need to be calculated
                return remainingCalls.ToString();
            }</value>
        </set-header>
    </outbound>

    <on-error>
        <base />

        <!-- Customize rate limit error response -->
        <choose>
            <when condition="@(context.LastError.Reason == "QuotaExceeded" || context.LastError.Reason == "RateLimitExceeded")">
                <return-response>
                    <set-status code="429" reason="Too Many Requests" />
                    <set-header name="Retry-After" exists-action="override">
                        <value>60</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("error", "rate_limit_exceeded"),
                            new JProperty("message", "You have exceeded the rate limit. Please try again later."),
                            new JProperty("retryAfter", 60)
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
    </on-error>
</policies>